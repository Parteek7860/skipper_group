@{
    Layout = "~/Views/Shared/_homepage.cshtml";
    ViewBag.Title = "Applications";
}

<div class="block-header">
    <div class="row">
        <div class="col-lg-7 col-md-6 col-sm-12">
            <h2>
                @ViewBag.Title
                <small class="text-muted">@Context.Session.GetString("ClientName")</small>
            </h2>
        </div>
        <div class="col-lg-5 col-md-6 col-sm-12">
            <ul class="breadcrumb float-md-right">
                <li class="breadcrumb-item"><a href="#"><i class="zmdi zmdi-home"></i>Application</a></li>
                <li class="breadcrumb-item active">Application List</li>
            </ul>
        </div>
    </div>
</div>



<div class="row clearfix">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="card">
            <div class="body">
                <div class="row clearfix">
                    <div class="col-sm-12">
                        @{
                            var A = ViewBag.Applications as List<skipper_group_new.Models.Applicationview>;
                        }

                        @if (A != null && A.Any())
                        {
                            <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search..." onkeyup="searchTable()" />
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="fromDate" style="font-weight: bold;">From Date</label>
                                    <input type="date" id="fromDate" class="form-control" style="border-radius: 5px; border: 1px solid #ddd;" />
                                </div>
                                <div class="col-md-3">
                                    <label for="toDate" style="font-weight: bold;">To Date</label>
                                    <input type="date" id="toDate" class="form-control" style="border-radius: 5px; border: 1px solid #ddd;" />
                                </div>
                            </div>
                            <div class="row mb-4">
                                    <div class="col-lg-2" style="padding-top:10px;">
                                    <button class="btn btn-primary" type="button" onclick="filterByDate()" style="width: 50%; padding: 10px; border-radius: 5px; font-weight: bold;background-color:#456976 !important">Search</button>
                                </div>
                            </div>

                            <table class="table table-bordered" id="productTable">
                                <thead class="table-header">
                                    <tr>
                                        <th>Sr.</th>
                                        <th>Name</th>
                                        <th>Gender</th>
                                        <th>Email</th>
                                        <th>Experience</th>
                                          <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int srNo = 1;
                                    }
                                    @foreach (var i in A)
                                    {
                                        <tr>
                                            <td>@srNo</td>
                                            <td>@($"{i.FName} {i.LName}")</td>
                                            <td>@i.Gender</td>
                                            <td>@i.App_Email</td>
                                            <td>@($"{i.App_Expyear}.{i.App_Expmonth} years")</td>
                                              <td>@i.Trdate.ToString("dd-MMM-yyyy")</td>
                                            <td>
                                                <a href="/backoffice/career/downloadresume/@i.App_id" class="btnDownload">
                                                    <img src="~/backoffice/images/Download_24x24.png" class="img-fluid" width="30" alt="Download" title="Download" />
                                                </a>
                                                <a href="/backoffice/career/GetApplicantDetail/@i.App_id" class="btnView">
                                                    <img src="~/Backoffice/images/view_icon.svg" class="img-fluid" width="30" alt="View"  title="Click to View" />
                                                </a>
                                            </td>
                                        </tr>
                                        srNo++;
                                    }
                                </tbody>
                            </table>
                            <div class="pagination-container text-center mt-3" style="text-align:right;">
                                <button id="prevPage" class="btn btn-secondary" style="background-color:#456976;">Previous</button>
                                <span id="pageInfo" class="mx-2"></span>
                                <button id="nextPage" class="btn btn-secondary" style="background-color:#456976;">Next</button>
                            </div>

                        }
                        else
                        {
                          <div class="col-lg-12 my-lg-2 text-lg-center message-top2">
                                    Records not found
                                </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Applicant Details Modal -->
<div class="modal fade" id="viewApplicantModal" tabindex="-1" aria-labelledby="viewApplicantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius:12px; overflow:hidden; box-shadow:0 5px 25px rgba(0,0,0,0.2);">
            <div class="modal-header" style="background:#af895aeb; color:white;">
                <h5 class="modal-title" id="viewApplicantModalLabel" style="font-weight:600;">Applicant Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" id="applicantDetailsBody"
                 style="background-color:#f9fafb; padding:30px; font-family:'Segoe UI',Roboto,Arial,sans-serif; color:#333;">

                <div class="container-fluid" style="max-width:95%;">
                    <!-- Each row -->
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Name:</label>
                            <div id="aplName" style="color:#007bff;"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">DOB:</label>
                            <div id="aplDOB" style="color:#007bff;"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Gender:</label>
                            <div id="aplGender"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Marital Status:</label>
                            <div id="aplMaritalStatus"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Father/Husband Name:</label>
                            <div id="aplFName"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Address:</label>
                            <div id="aplAddress"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Mobile Number:</label>
                            <div id="aplMobile"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Telephone:</label>
                            <div id="aplTelephone"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Email:</label>
                            <div id="aplEmail" style="color:#007bff; word-break:break-word;"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">City:</label>
                            <div id="aplCity"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">State:</label>
                            <div id="aplState"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Qualification:</label>
                            <div id="aplQualification"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Total Experience:</label>
                            <div id="aplexperience"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Skills:</label>
                            <div id="aplSkills"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Function:</label>
                            <div id="aplFunction"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Current Industry:</label>
                            <div id="aplIndustry"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Location:</label>
                            <div id="aplLocation"></div>
                        </div>
                        <div class="col-sm-6">
                            <label style="font-weight:600;">Current Salary:</label>
                            <div id="aplSalary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@{
    var nonce = Context.Items["CSPNonce"]?.ToString();
}

<script nonce="@nonce">
    document.addEventListener('DOMContentLoaded', function () {
        const deleteButtons = document.querySelectorAll('.btndelete');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                if (confirm("Are you sure you want to delete this record?")) {
                    window.location.href = btn.getAttribute('data-href');
                }
            });
        });
    });

    function searchTable() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#productTable tbody tr');
        rows.forEach(row => {
            const match = Array.from(row.getElementsByTagName('td')).some(td =>
                td.textContent.toLowerCase().includes(input)
            );
            row.style.display = match ? '' : 'none';
        });
    }

    function filterByDate() {
        const fromVal = document.getElementById('fromDate').value;
        const toVal = document.getElementById('toDate').value;

        const fromDate = fromVal ? new Date(fromVal) : null;
        const toDate = toVal ? new Date(toVal) : null;
        if (toDate) toDate.setDate(toDate.getDate() + 1);

        const rows = document.querySelectorAll('#productTable tbody tr');
        rows.forEach(row => {
            const dateText = row.querySelectorAll('td')[6]?.textContent.trim();
            const trDate = new Date(dateText.split('-').reverse().join('-'));
            let show = true;
            if (fromDate && trDate < fromDate) show = false;
            if (toDate && trDate >= toDate) show = false;
            row.style.display = show ? '' : 'none';
        });
    }



    let currentPage = 1;
    const rowsPerPage = 10;
    function paginateTable() {
        const table = document.getElementById('productTable');
        const rows = table.querySelectorAll('tbody tr');
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        rows.forEach(row => row.style.display = 'none');
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        rows.forEach((row, index) => {
            if (index >= start && index < end) {
                row.style.display = '';
            }
        });
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            paginateTable();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        const table = document.getElementById('productTable');
        const rows = table.querySelectorAll('tbody tr');
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            paginateTable();
        }
    });
    document.addEventListener('DOMContentLoaded', paginateTable);

        document.addEventListener("DOMContentLoaded", function () {
        const viewButtons = document.querySelectorAll(".btnView");

        viewButtons.forEach(btn => {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                const url = btn.getAttribute("href");
                const appId = url.split('/').pop();
                const modalEl = document.getElementById("viewApplicantModal");
                const modal = new bootstrap.Modal(modalEl);
                const body = document.getElementById("applicantDetailsBody");

                // Show temporary loading message without deleting spans
                const originalContent = body.innerHTML;
                body.innerHTML = `
                    <div class="text-center p-4" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Loading applicant details...</p>
                    </div>
                `;

                fetch(`/backoffice/career/GetApplicantDetail/${appId}`)
                    .then(response => {
                        if (!response.ok) throw new Error("Network response was not ok");
                        return response.json();
                    })
                    .then(result => {
                        // Restore body structure
                        body.innerHTML = originalContent;

                        if (!result.success) {
                            body.innerHTML = `<div class="alert alert-danger text-center">${result.message}</div>`;
                            modal.show();
                            return;
                        }

                        const d = result.data;
                       console.log("result:", d);
                        document.getElementById("aplName").textContent = d.name || "";
                        document.getElementById("aplDOB").textContent = d.dob || "";
                        document.getElementById("aplGender").textContent = d.gender || "";
                        document.getElementById("aplMaritalStatus").textContent = d.maritalStatus || "";
                        document.getElementById("aplFName").textContent = d.fatherName || "";
                        document.getElementById("aplAddress").textContent = d.address || "";
                        document.getElementById("aplMobile").textContent = d.mobile || "";
                        document.getElementById("aplTelephone").textContent = d.telephone || "";
                        document.getElementById("aplEmail").textContent = d.email || "";
                        document.getElementById("aplCity").textContent = d.city || "";
                        document.getElementById("aplState").textContent = d.state || "";
                        document.getElementById("aplQualification").textContent = d.qualification || "";
                        document.getElementById("aplexperience").textContent = d.experience || "";
                        document.getElementById("aplSkills").textContent = d.skills || "";
                        document.getElementById("aplFunction").textContent = d.function || "";
                        document.getElementById("aplIndustry").textContent = d.industry || "";
                        document.getElementById("aplLocation").textContent = d.location || "";
                        document.getElementById("aplSalary").textContent = d.salary || "";

                        modal.show();
                    })

                    .catch(error => {
                        console.error("Error loading applicant details:", error);
                        body.innerHTML = `<div class="alert alert-danger text-center">Failed to load applicant details.</div>`;
                        modal.show();
                    });
            });
        });
    });

    setTimeout(function () {
        var msg = document.getElementById("message");
        if (msg) {
            msg.style.display = "none";
        }
    }, 3000);
</script>
